<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Queens Art Venue Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" rel="stylesheet" />

  <!-- Custom styles -->
  <style>
    body, html {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    #legend-wrapper {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: sans-serif;
      font-size: 14px;
      width: 240px;
      max-height: 500px;
      overflow-y: auto;
    }

    #legend-toggle {
      width: 100%;
      background: #eee;
      border: none;
      padding: 6px;
      margin-bottom: 8px;
      cursor: pointer;
    }

    #legend.hidden {
      display: none;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .custom-marker {
      background-repeat: no-repeat;
      background-position: center;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div id="legend-wrapper">
    <button id="legend-toggle">Hide Legend</button>
    <div id="legend"></div>
  </div>

  <!-- Mapbox JS + Geocoder + PapaParse -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Your custom map script -->
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZmx1c2hpbmd0b3duaGFsbCIsImEiOiJjbWEzYmUzMWEwbnN3MmxwcjRyZG55ZmNxIn0.WRThoxFMtqTJQwV6Afv3ww'; // üîÅ Replace with yours

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/flushingtownhall/cma3bhpb4000l01qwf955dtqx',
      center: [-73.8291, 40.7282], // Centered on Queens
      zoom: 11
    });

    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl,
      placeholder: 'Search Queens...',
      marker: { color: 'red' },
      countries: 'us'
    });

    map.addControl(geocoder);

    // Globals
    let allMarkers = [];
    const tagGroups = {};
    const tagColors = {};
    const colorPalette = [
      '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231',
      '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe',
      '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000'
    ];

    function getColorForTag(tag) {
      if (!tagColors[tag]) {
        const color = colorPalette[Object.keys(tagColors).length % colorPalette.length];
        tagColors[tag] = color;
      }
      return tagColors[tag];
    }

    function createColorIcon(color) {
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="40" viewBox="0 0 24 24" fill="${color}">
          <path d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7z"/>
        </svg>
      `);
      return `data:image/svg+xml,${svg}`;
    }

    function fetchData() {
      const sheetURL = 'https://docs.google.com/spreadsheets/d/14m6_RP2yfUjLirv8HC5xav8sIMKFVuT4BHW-vRZqB-Q/export?format=csv';
      fetch(sheetURL)
        .then(res => res.text())
        .then(csv => {
          Papa.parse(csv, {
            header: true,
            dynamicTyping: true,
            complete: result => addMarkers(result.data)
          });
        });
    }

    function addMarkers(data) {
      allMarkers.forEach(m => m.remove());
      allMarkers = [];
      Object.keys(tagGroups).forEach(k => tagGroups[k] = []); // reset tagGroups

      data.forEach(row => {
        const lat = parseFloat(row.Latitude);
        const lng = parseFloat(row.Longitude);
        if (isNaN(lat) || isNaN(lng)) return;

        const org = row["Org Name"] || "Unnamed";
        const address = row["Address"] || "N/A";
        const email = row["Email"] || "";
        const phone = row["Phone"] || "";
        const tags = (row["Tags"] || "").split(',').map(t => t.trim()).filter(Boolean);
        const website = row["Website"] || "";
        const social = row["Social"] || "";
        const image = row["Image"] || "";

        const popupHTML = `
          <div style="max-width: 300px;">
            ${image ? `<img src="${image}" style="width:100%; max-height:200px; object-fit:cover; border-radius:8px; margin-bottom:8px;" />` : ""}
            <h3>${org}</h3>
            <p><strong>Address:</strong><br>${address}</p>
            ${email ? `<p><strong>Email:</strong><br><a href="mailto:${email}">${email}</a></p>` : ""}
            ${phone ? `<p><strong>Phone:</strong><br>${phone}</p>` : ""}
            ${tags.length ? `<p><strong>Tags:</strong><br>${tags.join(', ')}</p>` : ""}
            ${website ? `<p><strong>Website:</strong><br><a href="${website}" target="_blank">${website}</a></p>` : ""}
            ${social ? `<p><strong>Social:</strong><br>${social}</p>` : ""}
          </div>
        `;

        tags.forEach(tag => {
          const color = getColorForTag(tag);
          const el = document.createElement('div');
          el.className = 'custom-marker';
          el.style.backgroundImage = `url(${createColorIcon(color)})`;
          el.style.width = '30px';
          el.style.height = '40px';
          el.style.backgroundSize = 'contain';

          const marker = new mapboxgl.Marker(el)
            .setLngLat([lng, lat])
            .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupHTML))
            .addTo(map);

          marker.rowData = row;
          allMarkers.push(marker);
          if (!tagGroups[tag]) tagGroups[tag] = [];
          tagGroups[tag].push(marker);
        });
      });

      buildLegendByTag();
    }

    function buildLegendByTag() {
      const legend = document.getElementById('legend');
      legend.innerHTML = '';
      const selectedTags = new Set(Object.keys(tagGroups));

      Object.keys(tagGroups).forEach(tag => {
        const color = getColorForTag(tag);
        const item = document.createElement('label');
        item.className = 'legend-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.dataset.tag = tag;

        checkbox.addEventListener('change', () => {
          checkbox.checked ? selectedTags.add(tag) : selectedTags.delete(tag);
          filterMarkersByTags(selectedTags);
        });

        const swatch = document.createElement('span');
        swatch.style.backgroundColor = color;
        swatch.style.width = '16px';
        swatch.style.height = '16px';
        swatch.style.borderRadius = '50%';

        const label = document.createElement('span');
        label.textContent = tag;

        item.appendChild(checkbox);
        item.appendChild(swatch);
        item.appendChild(label);
        legend.appendChild(item);
      });

      filterMarkersByTags(selectedTags);
    }

    function filterMarkersByTags(selectedTags) {
      allMarkers.forEach(marker => {
        const venueTags = (marker.rowData.Tags || "")
          .split(",")
          .map(t => t.trim().toLowerCase());

        const matchAll = [...selectedTags].every(tag => venueTags.includes(tag.toLowerCase()));
        marker.getElement().style.display = matchAll ? 'block' : 'none';
      });
    }

    document.getElementById('legend-toggle').addEventListener('click', () => {
      const legend = document.getElementById('legend');
      const btn = document.getElementById('legend-toggle');
      const isHidden = legend.classList.toggle('hidden');
      btn.textContent = isHidden ? 'Show Legend' : 'Hide Legend';
    });

    map.on('load', fetchData);
  </script>
</body>
</html>
